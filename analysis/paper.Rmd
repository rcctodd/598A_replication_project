---
title: "Replication in Archaeological Science: Shape as a Measure of Weapon Standardisation"
author: "Team Fresh"
date: "2/24/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  warning = FALSE,
  message = FALSE
)
```

## Introduction

The traditional approach to evaluating the level of manufacturing standardization in a society has involved the comparison of standard dimensional measurements of the object through the coefficient of variation (CV) metric. Computed as a simple ratio of the standard deviation to the mean, and scaled by 100 as shown below, the coefficient of variation provides an easily interpretable measure of variation that can be compared to other measurements with different mean values.

$$ CV = \frac{stdev}{mean}*100 $$

However, in the paper _Shape as a measure of weapon standardization: From metric to geometric morphometric analysis of the Iron Age ‘Havor’ lance from Southern Scandinavia_ by Birch and Martinon-Torres, a new approach is proposed. Instead of relying on dimensional comparison of different CVs, they propose using a Geomorphic Morphometric (GMM) analysis as a general measure of overall shape.

In this work, we are attempting to confirm that the underlying data provided is the same as that used in the original study by replicating the figure showing the pair-wise correlation of all lance dimensions across the three underlying datasets (original study Fig 8). We are also attempting to replicate the original finding that there was found to be an association between overall centroid size and shape that could not be explained through site difference via an ANOVA analysis.

## Methods

The original analysis was conducted in an unspecified version of R. However, specific versions of geomorph(v3.0.6) and shapes(v1.2.3), two of the most important packages, were directly stated. Our reproduction attempt began with importing the packages explicitly identified in the paper as well as those required in the technical code.

<insert load packages block here>

Our next step was to set the working directory. Although a trivial step, the original code used setwd() and a static path string while our reproduction attempt opted to use the more robust here() library as shown below.

<insert set working dir here>

Next, we read in and shaped the data obtained from the ScieceDirect archive of the paper using the same code as the original paper, slightly modified to account for our modified approach to setting the working directory. 

<insert read in data here>

With the R session properly configured, correct packages installed, and data loaded and shaped according to the paper and provided R file, we were then able to proceed with our attempt at replicating the correlation matrix of lance dimensions shown in Figure 8 of the original paper. This is where we encountered our first issue, as the code used to create the figure was not included in the R file. Instead a series of five corr() statements (shown below) comparing a subset of lance features were included with the resulting correlation coefficients included in the comments.

Pairwise correlations of lance features
cor(socket$socket_length,socket$sock_bdiam,use="pairwise.complete.obs") # 0.52
cor(socket$sock_bdiam,socket$sock_sdiam,use="pairwise.complete.obs")    # 0.52
cor(lances_M$width,lances_M$thickness,use="pairwise.complete.obs")      # 0.53
cor(blade$blade_length,blade$width,use="pairwise.complete.obs")         # 0.58
cor(blade$blade_length,blade$thickness,use="pairwise.complete.obs")     # 0.47

We then attempted to replicate the figure with the ggpairs() library and perform a visual comparison to Figure 8.

Finally, we attempted to replicate the original finding that there was found to be an association between overall centroid size and shape that could not be explained through site difference via an ANOVA analysis. This test was described on page 44 of the original paper as well as in the R document and relies on the procD.allometry() function from the geomorph package.


## Results

Unfortunately, the pairwise correlation coefficients noted in the comments were not the same as the ones shown in Figure 8. This inconsistiency made it more difficult to confirm the success of our replication attempt. 

Luckily, we were able to replicate the finding that there was found to be an association between overall centroid size and shape that could not be explained through site difference via an ANOVA analysis on page 44 of the original paper


```{r load packages, include=TRUE}
#adding this line as a git test
#install specific versions of pakages called out in the paper
#require(devtools)
library(devtools)
#install_version("geomorph", version = "3.0.6", repos = "http://cran.rstudio.com")
#install_version("geomorph", version = "3.0.6", repos = "http://cran.r-project.org")
#install.packages("http://https://cran.r-project.org/src/contrib/Archive/geomorph/geomorph_3.0.6.tar.gz", repos=NULL, type="source")
library(geomorph) # geomorph 3.0.6

install_version("shapes", version = "1.2.3", repos = "http://cran.rstudio.com/") #"http://cran.rstudio.com")
#install_version("shapes", version = "1.2.3", repos = "http://cran.rstudio.com/") #"http://cran.us.r-project.org")
library(shapes) # shapes 1.2.3

#not mentioned in the technical appendix, but required in technical code
library(shapes)

#package for lattice replication
library(GGally)

#package to support updating geomoreph code
library(RRPP)

```

```{r set working directory, include=TRUE}
#setwd(dirname(rstudioapi::getSourceEditorContext()$path))
#getwd()
library(here)
```

```{r load data, include=TRUE}
# Read the datafile "lances_M" containing a matrix of dimensional data (metric)

#replication file names did not survive publication!
#lances_M<-read.csv("Data/1-s2.0-S0305440318306757-mmc2.csv",header=TRUE)
lances_M<-read.csv(here("Data","1-s2.0-S0305440318306757-mmc2.csv"),header=TRUE)

# Read the datafile "lances_GMM" containing a matrix of landmark data (geometric morphometric)
#lances_GMM<-read.csv("Data/1-s2.0-S0305440318306757-mmc3.csv",header=TRUE)
lances_GMM<-read.csv(here("Data","1-s2.0-S0305440318306757-mmc3.csv"),header=TRUE)

# Convert the 2D matrix of geometric morphometric data ("lances_GMM") into a 3D array
lances_geo<-arrayspecs(lances_GMM[,2:15],7,2) # 7 landmarks, recording 2 dimensions only (xy coordinates), ignoring the first column of lance IDs

```

```{r analysis 1, include=TRUE}
# Before undertaking any descriptive statistics of the metric dimensions of the lances, it is important to re-sort the data matrix and subset the data.
lances_M$site<-factor(lances_M$site,
                    levels = c("Ejsbol","Nydam", "Illerup"),
                    labels = c("Ejsbol","Nydam", "Illerup"),
                    ordered=T)                                # This simply converts the variable 'site' into an ordered variable of factors with levels.

# The data can be subset into specific features of the lance, so that only cases with complete data are used
blade<-subset(lances_M, point=='yes')                                 # Selects all cases with complete blades
socket<-subset(lances_M, socket=='yes')                               # Selects all cases with complete sockets
total<-subset(lances_M, point=='yes' & socket=='yes')                 # Selects all 'complete' lances with all features

# Pairwise correlations of lance features
cor(socket$socket_length,socket$sock_bdiam,use="pairwise.complete.obs") # 0.52
cor(socket$sock_bdiam,socket$sock_sdiam,use="pairwise.complete.obs")    # 0.52
cor(lances_M$width,lances_M$thickness,use="pairwise.complete.obs")      # 0.53
cor(blade$blade_length,blade$width,use="pairwise.complete.obs")         # 0.58
cor(blade$blade_length,blade$thickness,use="pairwise.complete.obs")     # 0.47

# Principal Components Analysis of Havor lance dimensions
totalpca<-prcomp(~total_length+blade_length+socket_length+sock_bdiam+sock_sdiam+width+thickness,data=total,center=T,scale=T)
totalpca        # By typing 'totalpca' a full summary of the components is printed in the terminal.
str(totalpca)   # More information can be viewed about the PCA results by looking at the 'total' object in more detail.

# Heirarchical Cluster Analysis of Havor lance dimensions
#totalhc <-hclust(dist(total[,(c(1,5:11))]), "average")  # The cluster analysis is performed
#totalhc1<-as.dendrogram(totalhc)                        # The cluster analysis results are converted into a dendrogram object
#plot(totalhc1)                                          # Plots the resulting dendrogram object
```
```{r analysis 1.1, include=FALSE}
# Heirarchical Cluster Analysis of Havor lance dimensions
# The cluster analysis is performed
totalhc <-hclust(dist(total[,(c(1,5:11))]), "average")
# The cluster analysis results are converted into a dendrogram object
totalhc1<-as.dendrogram(totalhc)                      
```
```{r analysis 1.2, include=TRUE}
# Plots the resulting dendrogram object
plot(totalhc1)
```
```{r analysis 2, include=FALSE}

  
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-
                          #### 4. GEOMETRIC MORPHOMETRICS (GMM): LANDMARKS DATA ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-

# Create the links (this specifies the order of landmarks by which to connect linking lines)
outline<-rbind(c(1,2),c(2,3),c(3,4),c(4,5),c(5,6),c(6,7),c(7,1))

                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-
                          #### 5. GMM DATA MANIPULATION ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-

# Subset the data into different sites
Eco<-lances_geo[,,1:6]    # Ejsbol (n=6)
Nco<-lances_geo[,,7:30]   # Nydam (n=24)
Ico<-lances_geo[,,31:78]  # Illerup (n=48)

```

```{r plotting digitized specs, include=FALSE}
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
                          #### 6. PLOTTING DIGITISED SPECIMENS ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#

# This function plots the landmarks of specimens recorded (as digitised)
plotAllSpecimens(lances_geo,links=outline)  # Plot landmarks of all specimens (digitised)
plotAllSpecimens(Eco,links=outline)         # Plot landmarks of Ejsbol lances (digitised)
plotAllSpecimens(Nco,links=outline)         # Plot landmarks of Nydam lances (digitised)
plotAllSpecimens(Ico,links=outline)         # Plot landmarks of Illerup lances (digitised)

```

```{r GPA, include=FALSE}

                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-
                          #### 7. GENERALISED PROCRUSTES ANALYSIS (GPA) ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-

# GPA is performed on the lances, including the semi-landmarks at the socket.
# The 'curves' argument is ignored to have permanent landmarks
lancespr<-gpagen(lances_geo)  # GPA of all lances
Epr<-gpagen(Eco)              # GPA of Ejsbol lances
Npr<-gpagen(Nco)              # GPA of Nydam lances
Ipr<-gpagen(Ico)              # GPA of Illerup lances

```

```{r plotting GPA, include=FALSE}


                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
                          #### 8. PLOTTING GPA SPECIMENS ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#

# This function plots the landmarks of GPA specimens
plotAllSpecimens(lancespr$coords,links=outline) # Plot landmarks of all specimens (GPA)
plotAllSpecimens(Epr$coords,links=outline)      # Plot landmarks of Ejsbol lances (GPA)
plotAllSpecimens(Npr$coords,links=outline)      # Plot landmarks of Nydam lances (GPA)
plotAllSpecimens(Ipr$coords,links=outline)      # Plot landmarks of Illerup lances (GPA)

# This function plots the shapes of GPA specimens
plotshapes(lancespr$coords,joinline=c(1:7,1),symbol=NA) # Plot shapes of all specimens (GPA)
plotshapes(Epr$coords,joinline=c(1:7,1),symbol=NA)      # Plot shapes of Ejsbol lances (GPA)
plotshapes(Npr$coords,joinline=c(1:7,1),symbol=NA)      # Plot shapes of Nydam lances (GPA)
plotshapes(Ipr$coords,joinline=c(1:7,1),symbol=NA)      # Plot shapes of Illerup lances (GPA)

```

```{r check size vs shape, include=FALSE}
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-
                          #### 9. ALLOMETRY: CHECKING IF SHAPE IS RELATED TO SIZE ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-

# Manually create a vector containing site
site<-as.factor(c(rep("Ejsbøl",6),rep("Nydam",24),rep("Illerup",48)))
site<-factor(site,levels=c("Ejsbøl","Nydam","Illerup")) # Create a vector for the different sites

# Create a geomorph data frame for analysis
lances_geomorph<-geomorph.data.frame(shape=lancespr$coords,site=site,size=lancespr$Csize,ind=lances_GMM$site_lance.id) # Parse the data into a geomorph data frame

# We can test to see if there is an association between centroid size and shape, before conducting further statistical analyses.

# The results are significant, but they cannot be explained by site difference
lances_ANOVA<-procD.allometry(shape ~ size, ~site, data=lances_geomorph,method="PredLine") # Optional right-hand formula for the inclusion of groups; "~site" can be removed to perform ANOVA on whole dataset
?procD.allometry
# lances_ANOVA<-procD.allometry(shape ~ size, data=lances_geomorph,method="PredLine") # As above, but with "~site" removed
#plot(lances_ANOVA)
#print(lances_ANOVA)

#Call:
#  procD.allometry(f1 = shape ~ size, f2 = ~site, data = lances_geomorph,      method = "PredLine") 
#
#Homogeneity of Slopes Test
#Df     RSS       SS      Rsq      F       Z Pr(>F)
#Common Allometry  74 0.76683                                        
#Group Allometries 72 0.74137 0.025466 0.030754 1.2366 0.67153  0.246
#
#The null hypothesis of parallel slopes is supported
#based on a significance criterion of alpha = 0.05 
#
#Based on the results of this test, the following ANOVA table is most appropriate
#
#Type I (Sequential) Sums of Squares and Cross-products
#Randomized Residual Permutation Procedure Used
#1000 Permutations
#ANOVA effect sizes and P-values based on empirical F distributions
#
#Df      SS       MS     Rsq      F        Z Pr(>F)  
#log(size)  1 0.05502 0.055024 0.06645 5.3098  1.91423  0.015 *
#  site       2 0.00619 0.003096 0.00748 0.2987 -0.80096  0.796  
#Residuals 74 0.76683 0.010363 0.92607                         
#Total     77 0.82805                                          
#---
#  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

```

```{r test mean shape diff, include=FALSE}
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-
                          #### 10. TESTING FOR MEAN SHAPE DIFFERENCE: HOTELLING T^2 STATISTIC AND GOODALL F STATISTIC ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-

# For testing the difference in mean shape (between sites) we use the raw digitised coordinates.
# By using 'scale=TRUE' in our argument, procrustes (with scaling) is carried out in the procedure.

test1<-testmeanshapes(Eco,Nco,resamples=1000,replace=TRUE,scale=TRUE) # Comparing the mean shape of Ejsbol with Nydam
# Results:
# Hotelling T^2 statistic: F=3.595 P=0.099
# Goodall F statistic: F= 0.084 P= 0.806

test2<-testmeanshapes(Eco,Ico,resamples=1000,replace=TRUE,scale=TRUE) # Comparing the mean shape of Ejsbol with Illerup
# Results:
# Hotelling T^2 statistic: F=5.746 P=0.004
# Goodall F statistic: F= 0.752 P= 0.430

test3<-testmeanshapes(Ico,Nco,resamples=1000,replace=TRUE,scale=TRUE) # Comparing the mean shape of Illerup with Nydam
# Results:
# Hotelling T^2 statistic: F=0.713 P=0.739
# Goodall F statistic: F= 0.829 P= 0.490


```

```{r ANOVA test, include=FALSE}
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
                          #### 11. PROCRUSTES ANALYSIS OF VARIANCE (ANOVA) ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#

# The Procrustes ANOVA is identical to permutational-MANOVA.
# We want to perform statistical tests for mean shape difference on the GPA specimens.

# Procustres ANOVA
lances_ANOVA2<-procD.lm(shape~site,data=lances_geomorph, iter=99)
print(lances_ANOVA2)

#Call:
#  procD.lm(f1 = shape ~ site, iter = 99, data = lances_geomorph)
#
#Type I (Sequential) Sums of Squares and Cross-products
#Randomized Residual Permutation Procedure Used
#100 Permutations
#ANOVA effect sizes and P-values based on empirical F distributions
#
#Df      SS        MS     Rsq      F        Z Pr(>F)
#site       2 0.01286 0.0064307 0.01553 0.5917 -0.44955    0.7
#Residuals 75 0.81519 0.0108691 0.98447                       
#Total     77 0.82805       
```

```{r PCA, include=FALSE}

                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
                          #### 12. PRINCIPAL COMPONENTS ANALYSIS (PCA) OF GENERALISED PROCRUSTES ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#

# PCA is carried out on procrustes aligned specimens.
lancespca<-plotTangentSpace(lancespr$coords,label=TRUE)
lancespca       # By typing 'lancespca' a full summary of the components is printed in the terminal.
str(lancespca)  # More information can be viewed about the PCA results by looking at the 'lancespca' object in more detail.
```

```{r JCA, include=FALSE}
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
                          #### 13. HEIRARCHICAL CLUSTER ANALYSIS (HCA) OF GENERALISED PROCRUSTES ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#

# HCA is carried out on procustes aligned specimens.
hc<-hclust(dist(two.d.array(lancespr$coords)), "average")  # The cluster analysis is performed
hc1<-as.dendrogram(hc)                  # The cluster analysis results are converted into a dendrogram object
plot(hc1)                               # Plots the resulting dendrogram object

```

```{r bilateral symmetry, include=FALSE}

                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-
                          #### 14. BILATERAL SYMMETRY INVESTIGATION ----
                          #-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-

# Define a matrix of the paired landmarks (i.e. S1 and S2, N1 and N2, W1 and W2)
lances_land.pairs<-matrix(c(1,7,2,6,3,5),nrow=3,ncol=2,byrow=TRUE)

# Perform an analysis f the directional and fluctuating asymmetry of Havor lances
lance.sym<-bilat.symmetry(A=shape,ind=ind,object.sym=TRUE,land.pairs=lances_land.pairs,data=lances_geomorph,RRPP=FALSE,iter=999)

# View the results (ANOVA table)
lance.sym

#Call:
#  bilat.symmetry(A = shape, ind = ind, object.sym = TRUE, land.pairs = lances_land.pairs,  
#                 data = lances_geomorph, iter = 999, RRPP = FALSE) 
#
#Symmetry (data) type: Object 
#
#Type I (Sequential) Sums of Squares and Cross-products
#Randomization of Raw Values used
#1000 Permutations
#
#Shape ANOVA
#Df      SS        MS     Rsq        F       Z Pr(>F)   
#ind        77 1.55153 0.0201498 0.99820 577.3822 23.2156  0.001 **
#  side        1 0.00011 0.0001059 0.00007   3.0349  1.3652  0.063 . 
#Residuals  77 0.00269 0.0000349 0.00173                           
#Total     155 1.55433                                             
#---
#  Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

# Plot the results
plot(lance.sym, warpgrids=TRUE)
```

### Reproducing Figure 8 and associated analysis

The figure that we are attepting to replicate is Figure 8, captioned as a  "Correlation matrix of Havor lance dimensions showing Pearson's r(lowerpanel), accompanying bivariate plots (upperpanel) and  distributions (histograms with kernel density estimation, on the diagonal). Red=Ejsbøl, green=Nydam, blue=Illerup."

Data appear to be drawn from the main lances_M dataframe, but the figure labels include "socket (max)" and "socket (min)" which do not haave obvious analogues in the column names.

A closer review of the paper leads us to the following line: "Although socket 'diameters' were measured, they are referred to here as minimum and maximum socket 'thickness' (p.38." This points us to two fields, which we can test against the summary table that is Table 1:

```{r replication target preparation, include=TRUE, echo=FALSE}

lances_M %>%
  dplyr::group_by(site) %>%
  dplyr::summarise(mean=mean(sock_sdiam, na.rm = TRUE), n = sum(!is.na(sock_sdiam)))

lances_M %>%
  dplyr::group_by(site) %>%
  dplyr::summarise(mean=mean(sock_bdiam, na.rm = TRUE), n = sum(!is.na(sock_bdiam)))

blade %>%
  dplyr::group_by(site) %>%
  dplyr::summarise(mean=mean(blade_length, na.rm = TRUE), n = sum(!is.na(blade_length)))
```

We can be confident therefore that "sock_bdiam" and "sock_sdiam" are the sources of "socket (max) [thickness (mm)]" and "socket (min) [thickness (mm)]" respectively. Using some custom functions and the excellent ggally package, we can produce a first replication of the figure.


```{r replication figure, include=TRUE, echo=FALSE}

#notes for those who follow:
# check variable names - dont think sock_bdiam etc. is the same as min max width
# color match
# label match

upper_fn <- function(data, mapping, ...){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_smooth(method=loess, fill="None", color="Black", ...) +
    geom_point(aes(color=site, alpha=0.5))
  p
}

diag_fn <- function(data, mapping, ...){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_histogram(bins=10, color="black", fill="cyan", aes(y = ..ncount..)) + 
    geom_density(color="red",aes(y = ..scaled..,color="red"))
  p
}

#COMMENTED OUT BY THOMAS IN ORDER TO KNIT
#ggpairs(lances_M, columns = c("total_length", "blade_length", "socket_length", #"sock_bdiam", "sock_sdiam", "width", "thickness"), 
#        upper=list(continuous = upper_fn),
#        diag=list(continuous = diag_fn),
#        lower=list(continuous = "cor")) + theme_minimal() +
#        ggsave(here("Images","replication_fig_8v1.png"))

#Copied to try to adjust to get to knit in Thomas's env
#COMMENTED OUT BY THOMAS IN ORDER TO KNIT
#ggpairs(lances_M, columns = c('total_length', 'blade_length', 'socket_length', 'sock_bdiam', 'sock_sdiam', 'width', #'thickness'),  
#        upper=list(continuous = upper_fn),
#        diag=list(continuous = diag_fn),
#        lower=list(continuous = "cor")) + theme_minimal() +
#        ggsave(here("Images","replication_fig_8v1.png"))

```

The correlation values to do not match the paper. A quick test with the stats passage verifies the results of our plot and confirms that the issue is not a mis-labelling of a spearman coefficient.

```{r replication corr test, include=TRUE, echo=FALSE}
cor(lances_M$socket_length,lances_M$sock_bdiam, use= "pairwise.complete.obs", method = "pearson")
cor(lances_M$socket_length,lances_M$sock_bdiam, use= "pairwise.complete.obs", method = "spearman")

cor(lances_M$sock_sdiam,lances_M$width, use= "pairwise.complete.obs", method = "pearson")
cor(lances_M$sock_sdiam,lances_M$width, use= "pairwise.complete.obs", method = "spearman")
```
Try recreating figure on different data subsets:

```{r replication corr test 2, include=TRUE, echo=FALSE}
#COMMENTED OUT BY THOMAS IN ORDER TO KNIT
#ggpairs(lances_M[complete.cases(lances_M),], columns = c("total_length", "blade_length", #"socket_length", "sock_bdiam", "sock_sdiam", "width", "thickness"), 
#        upper=list(continuous = upper_fn),
#        diag=list(continuous = diag_fn),
#        lower=list(continuous = "cor")) + theme_minimal() +
#        ggsave(here("Images","replication_fig_8_complete_cases_manual.png"))

#COMMENTED OUT BY THOMAS IN ORDER TO KNIT
#ggpairs(blade, columns = c("total_length", "blade_length", "socket_length", #"sock_bdiam", "sock_sdiam", "width", "thickness"), 
#        upper=list(continuous = upper_fn),
#        diag=list(continuous = diag_fn),
#        lower=list(continuous = "cor")) + theme_minimal() +
#        ggsave(here("Images","replication_fig_8_blade.png"))

#COMMENTED OUT BY THOMAS IN ORDER TO KNIT
#ggpairs(socket, columns = c("total_length", "blade_length", "socket_length", #"sock_bdiam", "sock_sdiam", "width", "thickness"), 
#        upper=list(continuous = upper_fn),
#        diag=list(continuous = diag_fn),
#        lower=list(continuous = "cor")) + theme_minimal() +
#        ggsave(here("Images","replication_fig_8_socket.png"))

#COMMENTED OUT BY THOMAS IN ORDER TO KNIT
#ggpairs(total, columns = c("total_length", "blade_length", "socket_length", #"sock_bdiam", "sock_sdiam", "width", "thickness"), 
#        upper=list(continuous = upper_fn),
#        diag=list(continuous = diag_fn),
#        lower=list(continuous = "cor")) + theme_minimal() +
#        ggsave(here("Images","replication_fig_8_blades_and_sockets.png"))
```

None of the author-defined data subsets (or a manual calculation based on on complete cases)allows us to replicate the correaltion results.

### Reproducing ANOVA analysis

As of geomorph version 3.1, the function procD.allmoetry has been deprecated (see https://rdrr.io/cran/geomorph/man/procD.allometry.html). This function underpinned the ANOVA tests provided in the technical code appendix. Thankfully, the specificity of the authors' instructions allow a previous version of geomorph to be installed!

We replicate the results of p.44 on the ANOVA tests used to establish whether there is a significant relationship between centroid size and shape.

```{r replication ANOVA  test, include=TRUE, echo=FALSE}
lances_ANOVA_site<-procD.allometry(shape ~ size, ~site, data=lances_geomorph,method="PredLine") 

print(lances_ANOVA_site)

```

The results match. We note that no seed is specified in the provided code, making the random resampling approach used volatile.

We can explore the effect of other parameters in the allometry ANOVA, to test whether the core conclusion holds. In the example below, we do not log-transform the size variable and we set a signficance threshold (alpha) of 0.1, rather than the default 0.05.

```{r explore ANOVA  test v1, include=TRUE, echo=FALSE}
lances_ANOVA_two<-procD.allometry(shape ~ size, ~site, logsz=FALSE, seed=42, alpha=0.1, data=lances_geomorph, method="PredLine") 

print(lances_ANOVA_two)

```

The core result holds! We can push these boundaries futher; removing residual randomnizatio and using Cohen’s f-squared values as the random distribution to
estimate effect size.

```{r explore ANOVA  test v2, include=TRUE, echo=FALSE}
lances_ANOVA_three <- procD.allometry(shape ~ size, ~site, logsz=FALSE, seed=42, alpha=0.1, effect.type="cohen", RRPP=FALSE, data=lances_geomorph, method="PredLine") 

print(lances_ANOVA_three)

```

The core result still holds.

## Conclusion

Our attempt at a replication of two parts of the paper _Shape as a measure of weapon standardization: From metric to geometric morphometric analysis of the Iron Age ‘Havor’ lance from Southern Scandinavia_ by Birch and Martinon-Torres was an overall success despite some missing documentation and inconsistencies between the paper and provided code.

Specifically, the replication attempt of the figure showing the pair-wise correlation of all lance dimensions across the three underlying datasets (original study Fig 8) was used to confirm that the underlying data provided by the authors was the same as that used in the analysis. This replication attempt was complicated by the lack of the code used to generate the plot in the provided R file. Additionally, the correlation coefficients noted in the R file comments did not match the figure in the original paper. We were able to create a similar figure to the one in the original paper; but without a clear expected outcome, we were unable to confirm that the provided dataset was the same one used in the analysis.

The second part of the original paper we attempted to replicate was the original finding that there was found to be an association between overall centroid size and shape that could not be explained through site difference via an ANOVA analysis. The code used to perform this analysis was included in the R file, and the expected results noted in the comments matched the original paper. This made it much easier to evaluate the accuracy of our replication. We ran the same analysis as noted in the provided R code and obtained the same results.

The combination of these two replication efforts combined to make this a successful replication attempt. Although our initial attempt cast doubt on the underlying data, the fact that the second replication matched the expected result suggests that the problem with the first attempt was a transcription error between code and paper and not an indication of bad underlying data.

## References

<What do we put in here???>